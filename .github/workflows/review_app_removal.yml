name: ğŸ”ª Suppression d'une recette jetable

# L'action est lancÃ©e lorsqu'une PR Ã©tiquetÃ©e Â« recette-jetable Â» est fermÃ©e ou que son Ã©tiquette est retirÃ©e.
# Les applications Nuxt2 et Django sont supprimÃ©es automatiquement par Scalingo
# lorque la PR est fermÃ©e ou fusionnÃ©e car il s'agit de recettes jetables.
# https://doc.scalingo.com/platform/app/review-apps
on:
  pull_request:
    types: [ closed ]

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.TEST_SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_ID: ${{ secrets.TEST_SUPABASE_PROJECT_ID }}
  BRANCH: ${{ github.head_ref }}
  PR_ID: ${{ github.event.number }}

jobs:
  delete:
    runs-on: ubuntu-latest
    if: github.event.label.name == 'recette-jetable' || contains( github.event.pull_request.labels.*.name, 'recette-jetable')

    steps:
    - name: ğŸš¶â€â™‚ï¸â€â¡ï¸ DÃ©placement vers la branche principale
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: ğŸ·ï¸ DÃ©finition des noms de la recette jetable
      run: |
        #Â Le nom est dÃ©terminÃ© automatiquement par Scalingo pour les applications Nuxt2 et Django
        # car ce sont des recettes jetables.
        # Suivons le mÃªme modÃ¨le pour Supabase et Nuxt3.
        echo "SUPABASE_REVIEW_APP_NAME=supabase-pr${PR_ID}" >> $GITHUB_ENV
        echo "NUXT_3_REVIEW_APP_NAME=nuxt3-pr${PR_ID}" >> $GITHUB_ENV

    - name: ğŸ› ï¸ Installation de Scalingo CLI
      uses: scalingo-community/setup-scalingo@87fe86eedc708ffb9d232c756b21f6a5784f6c8a # v0.1.1
      with:
        api_token: ${{ secrets.SCALINGO_API_TOKEN }}
        region: 'osc-fr1'

    - name: ğŸš® Suppression de l'application Nuxt3
      run: scalingo destroy --app "${NUXT_3_REVIEW_APP_NAME}" --force


    - name: ğŸ› ï¸ Installation de la CLI Supabase
      uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51
      with:
        version: latest

    - name: ğŸš® Suppression de la branche Supabase
      run: supabase branches --project-ref "${SUPABASE_PROJECT_ID}" delete "${SUPABASE_REVIEW_APP_NAME}"
