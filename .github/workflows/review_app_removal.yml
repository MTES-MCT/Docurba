name: ğŸ”ª Suppression d'une recette jetable

# L'action est lancÃ©e lorsqu'une PR Ã©tiquetÃ©e Â« recette-jetable Â» est fermÃ©e.
# Les applications Nuxt2 et Django sont supprimÃ©es automatiquement par Scalingo
# lorque la PR est fermÃ©e ou fusionnÃ©e car il s'agit de recettes jetables.
# https://doc.scalingo.com/platform/app/review-apps
on:
  pull_request:
    types: [ closed ]
  # https://docs.github.com/en/actions/how-tos/manage-workflow-runs/manually-run-a-workflow
  workflow_dispatch:


env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.TEST_SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_ID: ${{ secrets.TEST_SUPABASE_PROJECT_ID }}
  BRANCH: ${{ github.head_ref }}
  PR_ID: ${{ github.event.number }}

jobs:
  delete:
    runs-on: ubuntu-latest
    if: contains( github.event.pull_request.labels.*.name, 'recette-jetable')

    steps:
    - name: ğŸ·ï¸ DÃ©finition des noms de la recette jetable
      run: |
        #Â Le nom est dÃ©terminÃ© automatiquement par Scalingo pour les applications Nuxt2 et Django
        # car ce sont des recettes jetables.
        # Suivons le mÃªme modÃ¨le pour Supabase et Nuxt3.
        echo "SUPABASE_REVIEW_APP_NAME=supabase-pr${PR_ID}" >> $GITHUB_ENV
        echo "NUXT_3_REVIEW_APP_NAME=docurba-nuxt3-pr${PR_ID}" >> $GITHUB_ENV

    - name: ğŸ› ï¸ Installation de la CLI de Scalingo
      uses: scalingo-community/setup-scalingo@87fe86eedc708ffb9d232c756b21f6a5784f6c8a # v0.1.1
      with:
        api_token: ${{ secrets.SCALINGO_API_TOKEN }}
        region: 'osc-fr1'

    - name: ğŸš® Suppression de l'application Nuxt3
      run: scalingo destroy --app "${NUXT_3_REVIEW_APP_NAME}" --force


    - name: ğŸ› ï¸ Installation de la CLI de Supabase
      uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51
      with:
        version: latest

    - name: ğŸš® Suppression de la branche Supabase
      run: supabase branches --project-ref "${SUPABASE_PROJECT_ID}" delete "${SUPABASE_REVIEW_APP_NAME}"
