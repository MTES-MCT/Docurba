name: üïµ Cr√©ation d'une recette jetable

# L'action est lanc√©e lorsque l'√©tiquette ¬´¬†recette-jetable¬†¬ª est ajout√©e √† la PR.
on:
  pull_request:
    types: [ labeled ]
  # https://docs.github.com/en/actions/how-tos/manage-workflow-runs/manually-run-a-workflow
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}-${{ github.event.pull_request.number || github.sha }}

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.TEST_SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_ID: ${{ secrets.TEST_SUPABASE_PROJECT_ID }}
  BRANCH: ${{ github.head_ref }}
  PR_ID: ${{ github.event.number }}
  SCALINGO_DJANGO_APP_NAME: docurba-django-demo
  SCALINGO_NUXT_APP_NAME: docurba-nuxt-demo
  NUXT3_REPO_HTTPS: https://github.com/betagouv/docurba-nuxt3/
  NUXT3_BRANCH: main

jobs:
  create:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    if: github.event.action == 'labeled' && github.event.label.name == 'recette-jetable'

    steps:
    - name: üì• R√©cup√©ration du code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.0
      with:
        ref: ${{ env.BRANCH }}

    - name: üè∑Ô∏è D√©finition des noms de la recette jetable
      run: |
        #¬†Le nom est d√©termin√© automatiquement par Scalingo pour les applications Nuxt2 et Django
        # car ce sont des recettes jetables.
        # Suivons le m√™me mod√®le pour Supabase et Nuxt3.
        echo "SUPABASE_REVIEW_APP_NAME=supabase-pr${PR_ID}" >> $GITHUB_ENV
        echo "NUXT_3_REVIEW_APP_NAME=docurba-nuxt3-pr${PR_ID}" >> $GITHUB_ENV
        echo "NUXT_2_REVIEW_APP_NAME=${SCALINGO_NUXT_APP_NAME}-pr${PR_ID}" >> $GITHUB_ENV
        echo "DJANGO_REVIEW_APP_NAME=${SCALINGO_DJANGO_APP_NAME}-pr${PR_ID}" >> $GITHUB_ENV

    #¬†La version est fig√©e car la derni√®re version casse lors de l'envoi de la configuration.
    #¬†L'erreur est cryptique.
    - name: üõ†Ô∏è Installation de la CLI Supabase
      uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51
      with:
        version: 2.60.0

    - name: ü™Ü Creation de la branche Supabase
      run: |
       supabase branches --project-ref ${SUPABASE_PROJECT_ID} create ${SUPABASE_REVIEW_APP_NAME}

    - name: ü§π‚Äç‚ôÄÔ∏è Export des variables d'environment √† partir de Supabase
      shell: bash
      run: |
        until supabase branches --project-ref ${SUPABASE_PROJECT_ID} get ${SUPABASE_REVIEW_APP_NAME} -o env | grep --quiet "SUPABASE_URL" &> /dev/null
        do
          echo "Attendons que la base Supabase soit pr√™te pendant encore 20 secondes."
          sleep 20
        done

        env_vars=$(supabase branches --project-ref ${SUPABASE_PROJECT_ID} get ${SUPABASE_REVIEW_APP_NAME} -o env)
        declare -A env_dict
        env_dict["DATABASE_URL"]=$(echo "${env_vars}" | grep -w "POSTGRES_URL" | sed -r 's/POSTGRES_URL=//g' | sed -r 's/\"//g')
        env_dict["SUPABASE_ANON_KEY"]=$(echo "${env_vars}" | grep -w "SUPABASE_ANON_KEY" | sed -r 's/SUPABASE_ANON_KEY=//g' | sed -r 's/\"//g')
        env_dict["SUPABASE_ADMIN_KEY"]=$(echo "${env_vars}" | grep -w "SUPABASE_SERVICE_ROLE_KEY" | sed -r 's/SUPABASE_SERVICE_ROLE_KEY=//g' | sed -r 's/\"//g')
        env_dict["SUPABASE_URL"]=$(echo "${env_vars}" | grep -w "SUPABASE_URL" | sed -r 's/SUPABASE_URL=//g' | sed -r 's/\"//g')

        # https://www.chunyangwen.com/blog/shell/bash-array-dict.html
        for key in "${!env_dict[@]}"
        do
          value=${env_dict[${key}]};
          # https://docs.github.com/fr/actions/reference/workflows-and-actions/workflow-commands#masking-a-value-in-a-log
          echo "::add-mask::${value}";
          echo "${key}=${value}" >> $GITHUB_ENV
        done

    # La configuration de chaque nouvelle branche reprend celle par d√©faut et non celle du projet parent.
    #¬†Le fichier supabase/config.toml est le seul moyen document√© par Supabase
    # pour mettre √† jour la configuration d'un projet.
    #¬†https://github.com/orgs/supabase/discussions/3765
    #¬†https://supabase.com/docs/reference/cli/supabase-config-push
    - name: ü§π‚Äç‚ôÄÔ∏è Mise √† jour de la configuration de Supabase
      continue-on-error: true
      run: |
        supabase_branch_id=$(echo "${SUPABASE_URL}" | sed --expression 's/\(https:\/\/\|\.supabase\.co\)//g')
        supabase --project-ref "${supabase_branch_id}" --yes config push

    - name: üõ†Ô∏è Installation de la CLI Scalingo
      uses: scalingo-community/setup-scalingo@87fe86eedc708ffb9d232c756b21f6a5784f6c8a # v0.1.1
      with:
        #  Jeton personnel de C√©line Martinet Sanchez.
        api_token: ${{ secrets.SCALINGO_API_TOKEN }}
        region: 'osc-fr1'

    - name: ü™Ü Cr√©ation de l'application Nuxt 3
      run: |
        # Il n'est pas possible de cr√©er une recette jetable pour Nuxt3 car chaque recette jetable
        # s'appuie sur une branche Git diff√©rente de celle utilis√©e pour le d√©p√¥t parent.
        scalingo create "${NUXT_3_REVIEW_APP_NAME}"
        app_url="https://${NUXT_3_REVIEW_APP_NAME}.osc-fr1.scalingo.io"
        scalingo --app ${NUXT_3_REVIEW_APP_NAME} env-set \
         SUPABASE_URL="${SUPABASE_URL}" \
         SUPABASE_ADMIN_KEY="${SUPABASE_ADMIN_KEY}"\
         NODE_OPTIONS="--max-old-space-size=4096"
        scalingo --app "${NUXT_3_REVIEW_APP_NAME}" integration-link-create --branch "${NUXT3_BRANCH}" "${NUXT3_REPO_HTTPS}"
        scalingo --app "${NUXT_3_REVIEW_APP_NAME}" integration-link-manual-deploy main
        echo "NUXT3_URL=${app_url}" >> $GITHUB_ENV
        echo "Utilisation de la branche ${NUXT3_BRANCH}."
        echo "Pour d√©ployer une autre branche, vous pouvez modifier ce script ou utiliser l'interface graphique."

    - name: ü™Ü Cr√©ation et d√©ploiement de la recette jetable Nuxt2
      run: |
        # Le nom est cr√©√© par Scalingo.
        # Cr√©ation d'une recette jetable.
        scalingo --app ${SCALINGO_NUXT_APP_NAME} integration-link-manual-review-app ${{ github.event.number }}
        # Mise √† jour de la configuration.
        scalingo --app "${NUXT_2_REVIEW_APP_NAME}" env-set \
         SUPABASE_URL="${SUPABASE_URL}" \
         SUPABASE_ADMIN_KEY="${SUPABASE_ADMIN_KEY}" \
         SUPABASE_ANON_KEY="${SUPABASE_ANON_KEY}"\
         NUXT3_API_URL="${NUXT3_URL}"
        scalingo --app "${NUXT_2_REVIEW_APP_NAME}" integration-link-update --auto-deploy --branch "${BRANCH}" --destroy-on-close

    - name: ü™Ü D√©ploiement de la recette jetable Nuxt2
      run: |
        # D√©ploiement manuel.
        scalingo --app "${NUXT_2_REVIEW_APP_NAME}" integration-link-manual-deploy "${BRANCH}"  &> /dev/null
        # R√©cup√©ration de NUXT_URL pour Django.
        until scalingo apps | grep "${NUXT_2_REVIEW_APP_NAME}" | grep --quiet 'running' &> /dev/null
        do
          echo "En attente de l'application Nuxt."
          sleep 1m
        done
        nuxt_url=$(scalingo --app "${NUXT_2_REVIEW_APP_NAME}" env-get NUXT_URL)
        echo "NUXT_URL=${nuxt_url}" >> $GITHUB_ENV

    - name: üõ†Ô∏è Installation de Python
      uses: actions/setup-python@v5
      with:
        python-version-file: django/.python-version

    - name: ü™Ü Cr√©ation de la recette jetable Django
      run: |
        # La longueur de la cl√© secr√®te doit √™tre sup√©rieure √† 50 caract√®res,
        # or le g√©n√©rateur de secret de Scalingo g√©n√®re une cl√© de 32 caract√®res.
        # Selon le support, il n'est pas possible d'en sp√©cifier la longueur dans scalingo.json.
        django_secret_key=$(python -c "import secrets; print(secrets.token_hex(60))")
        echo "::add-mask::${django_secret_key}";
        scalingo --app ${SCALINGO_DJANGO_APP_NAME} integration-link-manual-review-app ${{ github.event.number }}
        scalingo --app "${DJANGO_REVIEW_APP_NAME}" env-set \
         UPSTREAM_NUXT="${NUXT_URL}" \
         DATABASE_URL="${DATABASE_URL}" \
         NUXT3_API_URL="${NUXT3_URL}" \
         SECRET_KEY="${django_secret_key}"
        scalingo --app "${DJANGO_REVIEW_APP_NAME}" integration-link-update --auto-deploy --branch "${BRANCH}" --destroy-on-close

    - name: ü™Ü D√©ploiement de la recette jetable Django
      run: |
        scalingo --app "${DJANGO_REVIEW_APP_NAME}" integration-link-manual-deploy "${BRANCH}" &> /dev/null
        until scalingo apps | grep "${DJANGO_REVIEW_APP_NAME}" | grep --quiet 'running' &> /dev/null
        do
          echo "En attente de l'application Django pendant 1 minute."
          sleep 1m
        done
        django_url=$(scalingo --app "${DJANGO_REVIEW_APP_NAME}" env-get APP_URL)
        echo "DJANGO_URL=${django_url}" >> $GITHUB_ENV

    - name: ü§π‚Äç‚ôÄÔ∏è Int√©gration de l'URL de Django dans Nuxt2
      run: scalingo --app "${NUXT_2_REVIEW_APP_NAME}" env-set APP_URL="${DJANGO_URL}"

    - name: üçª Ajout du lien en commentaire de la PR
      uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3.0.1
      with:
        message: |-
          ü•Å La recette jetable est pr√™te ! [üëâ Je veux tester cette PR !](${{ env.DJANGO_URL }})
          Lien vers Nuxt3 pour modifier le d√©clencheur : [${{ env.NUXT3_URL }}](${{ env.NUXT3_URL }}).
          Attention, les donn√©es ne sont pas encore import√©es. Revenez quand l'action GitHub sera termin√©e.

    - name: üîÇ G√©n√©ration des donn√©es
      run: scalingo --app "${DJANGO_REVIEW_APP_NAME}" run './scripts/restore_database.sh ${DATABASE_URL}' &> /dev/null

    - name: ‚è© Lancement des migrations
      run: |
        # La connexion PG doit √™tre lib√©r√©e avant de pouvoir passer les migrations
        # mais on ne sait jamais combien de temps Supabase met √† le faire.
        sleep 5m
        scalingo --app "${DJANGO_REVIEW_APP_NAME}" run 'django-admin migrate'
