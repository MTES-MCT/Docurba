name: ğŸ•µ CrÃ©ation d'une recette jetable

# L'action est lancÃ©e quand une Ã©tiquette est ajoutÃ©e Ã  la PR ou qu'un push est effectuÃ© sur la branche.
# `types: [ synchronize ]` cible les Ã©vÃ©nements `push`.
on:
  pull_request:
    types: [ labeled, synchronize ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}-${{ github.event.pull_request.number || github.sha }}

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.TEST_SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_ID: ${{ secrets.TEST_SUPABASE_PROJECT_ID }}
  BRANCH: ${{ github.head_ref }}
  PR_ID: ${{ github.event.number }}
  SCALINGO_DJANGO_APP_NAME: docurba-django-demo
  SCALINGO_NUXT_APP_NAME: docurba-nuxt-demo
  NUXT3_REPO: git@github.com:betagouv/docurba-nuxt3.git
  NUXT3_REPO_HTTPS: https://github.com/betagouv/docurba-nuxt3/
  NUXT3_BRANCH: main

jobs:
  create:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    if: github.event.action == 'labeled' && github.event.label.name == 'recette-jetable'

    steps:
    - name: ğŸš¶â€â™‚ï¸â€â¡ï¸ DÃ©placement vers la branche principale
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        ref: ${{ github.head_ref }}

    - name: ğŸ“¥ RÃ©cupÃ©ration des branches Git
      run: git fetch --prune --unshallow

    - name: ğŸ·ï¸ DÃ©finition des noms de la recette jetable
      run: |
        #Â Le nom est dÃ©terminÃ© automatiquement par Scalingo pour les applications Nuxt2 et Django
        # car ce sont des recettes jetables.
        # Suivons le mÃªme modÃ¨le pour Supabase et Nuxt3.
        echo "SUPABASE_REVIEW_APP_NAME=supabase-pr${PR_ID}" >> $GITHUB_ENV
        echo "NUXT_3_REVIEW_APP_NAME=nuxt3-pr${PR_ID}" >> $GITHUB_ENV
        echo "NUXT_2_REVIEW_APP_NAME=${SCALINGO_NUXT_APP_NAME}-pr${PR_ID}" >> $GITHUB_ENV
        echo "DJANGO_REVIEW_APP_NAME=${SCALINGO_DJANGO_APP_NAME}-pr${PR_ID}" >> $GITHUB_ENV

    - name: ğŸ› ï¸ Installation de la CLI Supabase
      uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51
      with:
        version: latest

    - name: ğŸª† Creation de la branche Supabase
      run: |
       supabase branches --experimental --project-ref ${SUPABASE_PROJECT_ID} create ${SUPABASE_REVIEW_APP_NAME}

    - name: ğŸ¤¹â€â™€ï¸ Export des variables d'environment Ã  partir de Supabase
      shell: bash
      run: |
        until supabase branches --project-ref ${SUPABASE_PROJECT_ID} get ${SUPABASE_REVIEW_APP_NAME} -o env | grep --quiet "SUPABASE_URL" &> /dev/null
        do
          echo "Attendons que la base Supabase soit prÃªte pendant encore 20 secondes."
          sleep 20
        done

        env_vars=$(supabase branches --project-ref ${SUPABASE_PROJECT_ID} get ${SUPABASE_REVIEW_APP_NAME} -o env)
        declare -A env_dict
        env_dict["DATABASE_URL"]=$(echo "${env_vars}" | grep -w "POSTGRES_URL" | sed -r 's/POSTGRES_URL=//g' | sed -r 's/\"//g')
        env_dict["SUPABASE_ANON_KEY"]=$(echo "${env_vars}" | grep -w "SUPABASE_ANON_KEY" | sed -r 's/SUPABASE_ANON_KEY=//g' | sed -r 's/\"//g')
        env_dict["SUPABASE_ADMIN_KEY"]=$(echo "${env_vars}" | grep -w "SUPABASE_SERVICE_ROLE_KEY" | sed -r 's/SUPABASE_SERVICE_ROLE_KEY=//g' | sed -r 's/\"//g')
        env_dict["SUPABASE_URL"]=$(echo "${env_vars}" | grep -w "SUPABASE_URL" | sed -r 's/SUPABASE_URL=//g' | sed -r 's/\"//g')

        # https://www.chunyangwen.com/blog/shell/bash-array-dict.html
        for key in "${!env_dict[@]}"
        do
          value=${env_dict[${key}]};
          # https://docs.github.com/fr/actions/reference/workflows-and-actions/workflow-commands#masking-a-value-in-a-log
          echo "::add-mask::${value}";
          echo "${key}=${value}" >> $GITHUB_ENV
        done

    - name: ğŸ› ï¸ Installation de la CLI Scalingo
      uses: scalingo-community/setup-scalingo@87fe86eedc708ffb9d232c756b21f6a5784f6c8a # v0.1.1
      with:
        api_token: ${{ secrets.SCALINGO_API_TOKEN }}
        region: 'osc-fr1'

    - name: ğŸª† CrÃ©ation de l'application Nuxt 3
      run: |
        # Il n'est pas possible de crÃ©er une recette jetable pour Nuxt3 car chaque recette jetable
        # s'appuie sur une branche Git diffÃ©rente de celle utilisÃ©e pour le dÃ©pÃ´t parent.
        git clone https://github.com/betagouv/docurba-nuxt3.git
        cd docurba-nuxt3/
        scalingo create "${NUXT_3_REVIEW_APP_NAME}"
        app_url="https://${NUXT_3_REVIEW_APP_NAME}.osc-fr1.scalingo.io"
        scalingo --app ${NUXT_3_REVIEW_APP_NAME} env-set \
         SUPABASE_URL="${SUPABASE_URL}" \
         SUPABASE_ADMIN_KEY="${SUPABASE_ADMIN_KEY}"
         APP_URL="${app_url}"
        scalingo --app "${NUXT_3_REVIEW_APP_NAME}" integration-link-create --branch "${NUXT3_BRANCH}" "${NUXT3_REPO_HTTPS}"
        scalingo --app "${NUXT_3_REVIEW_APP_NAME}" integration-link-manual-deploy main
        echo "NUXT3_URL=${app_url}" >> $GITHUB_ENV
        echo "Utilisation de la branche ${NUXT3_BRANCH}."
        echo "Pour dÃ©ployer une autre branche, vous pouvez modifier ce script ou utiliser l'interface graphique."

    - name: ğŸª† CrÃ©ation de la recette jetable Nuxt2
      run: |
        # Le nom est crÃ©Ã© par Scalingo.
        # CrÃ©ation d'une recette jetable.
        scalingo --app ${SCALINGO_NUXT_APP_NAME} integration-link-manual-review-app ${{ github.event.number }}
        # Mise Ã  jour de la configuration.
        scalingo --app "${NUXT_2_REVIEW_APP_NAME}" integration-link-update --auto-deploy --branch "${BRANCH}" --destroy-on-close
        scalingo --app "${NUXT_2_REVIEW_APP_NAME}" env-set \
         SUPABASE_URL="${SUPABASE_URL}" \
         SUPABASE_ADMIN_KEY="${SUPABASE_ADMIN_KEY}" \
         SUPABASE_ANON_KEY="${SUPABASE_ANON_KEY}"\
         NUXT3_API_URL="${NUXT3_URL}"
        # DÃ©ploiement manuel.
        scalingo --app "${NUXT_2_REVIEW_APP_NAME}" integration-link-manual-deploy "${BRANCH}"
        # RÃ©cupÃ©ration de NUXT_URL pour Django.
        until scalingo --app "${NUXT_2_REVIEW_APP_NAME}" env-get APP_URL &> /dev/null
        do
          echo "En attente de l'application Nuxt."
          sleep 1m
        done
        nuxt_url=$(scalingo --app "${NUXT_2_REVIEW_APP_NAME}" env-get APP_URL)
        echo "NUXT_URL=${nuxt_url}" >> $GITHUB_ENV

    - name: ğŸ› ï¸ Installation de Python
      uses: actions/setup-python@v5
      with:
        python-version-file: django/.python-version

    - name: ğŸª† CrÃ©ation de la recette jetable Django
      run: |
        # La longueur de la clÃ© secrÃ¨te doit Ãªtre supÃ©rieure Ã  50 caractÃ¨res,
        # or le gÃ©nÃ©rateur de secret de Scalingo gÃ©nÃ¨re une clÃ© de 32 caractÃ¨res.
        # Selon le support, il n'est pas possible d'en spÃ©cifier la longueur dans scalingo.json.
        django_secret_key=$(python -c "import secrets; print(secrets.token_hex(60))")
        echo "::add-mask::${django_secret_key}";
        scalingo --app ${SCALINGO_DJANGO_APP_NAME} integration-link-manual-review-app ${{ github.event.number }}
        scalingo --app "${DJANGO_REVIEW_APP_NAME}" integration-link-update --auto-deploy --branch "${BRANCH}" --destroy-on-close
        scalingo --app "${DJANGO_REVIEW_APP_NAME}" env-set \
         UPSTREAM_NUXT="${NUXT_URL}" \
         DATABASE_URL="${DATABASE_URL}" \
         NUXT3_API_URL="${NUXT3_URL}" \
         SECRET_KEY="${django_secret_key}"
        until scalingo --app "${DJANGO_REVIEW_APP_NAME}" env-get APP_URL &> /dev/null
        do
          echo "En attente de l'application Django pendant 1 minute."
          sleep 1m
        done
        django_url=$(scalingo --app "${DJANGO_REVIEW_APP_NAME}" env-get APP_URL)
        echo "DJANGO_URL=${django_url}" >> $GITHUB_ENV
        # Les donnÃ©es de la base sont restaurÃ©es pendant le dÃ©ploiement.
        # Le script est trop long pour la CLI de Scalingo qui renvoie une erreur.
        scalingo --app "${DJANGO_REVIEW_APP_NAME}" integration-link-manual-deploy "${BRANCH}" &> /dev/null

    - name: ğŸ¤¹â€â™€ï¸ IntÃ©gration de l'URL de Django dans Nuxt2
      run: scalingo --app "${NUXT_2_REVIEW_APP_NAME}" env-set DJANGO_API_BASE_URL="${DJANGO_URL}"

    - name: ğŸ» Ajout du lien en commentaire de la PR
      uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3.0.1
      with:
        message: |-
          ğŸ¥ La recette jetable est prÃªte ! [ğŸ‘‰ Je veux tester cette PR !](${{ env.DJANGO_URL }})
          Attention, les donnÃ©es ne sont pas encore importÃ©es. Essayez dans un quart d'heure environ.
