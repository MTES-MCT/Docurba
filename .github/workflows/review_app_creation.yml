name: ğŸ•µ Recettes jetables

# L'action est lancÃ©e quand une Ã©tiquette est ajoutÃ©e Ã  la PR ou qu'un push est effectuÃ© sur la branche.
# `types: [ synchronize ]` cible les Ã©vÃ©nements `push`.
on:
  pull_request:
    types: [ labeled, synchronize ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}-${{ github.event.pull_request.number || github.sha }}

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.TEST_SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_ID: ${{ secrets.TEST_SUPABASE_PROJECT_ID }}
  BRANCH: ${{ github.head_ref }}
  PR_ID: ${{ github.event.number }}
  SCALINGO_DJANGO_APP_NAME: docurba-django-demo
  SCALINGO_NUXT_APP_NAME: docurba-nuxt-demo
  NUXT3_REPO: git@github.com:betagouv/docurba-nuxt3.git
  NUXT3_REPO_HTTPS: https://github.com/betagouv/docurba-nuxt3/
  NUXT3_BRANCH: supabase-env #Â TODO(cms): change me to main when PR is merged.

jobs:
  create:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    if: github.event.action == 'labeled' && github.event.label.name == 'recette-jetable'

    steps:
    - name: ğŸš¶â€â™‚ï¸â€â¡ï¸ DÃ©placement vers la branche principale
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        ref: ${{ github.head_ref }}

    - name: ğŸ“¥ RÃ©cupÃ©ration des branches Git
      run: git fetch --prune --unshallow

    # Environment variables
    - name: ğŸ·ï¸ DÃ©finition du nom de la recette jetable
      run:
        # The review name can be used as a subdomain for some service (URL, S3, etc)
        # so we limit to the first 63 characters as it's the maximum length of a
        # domain label (part of domain name separated by dot).
        # https://datatracker.ietf.org/doc/html/rfc1035#section-2.3.4
        echo "REVIEW_APP_NAME=`echo \"docurba-pr-${PR_ID}-${BRANCH}\" | sed -r 's/[^[:alnum:]-]+/-/g' | head -c 63`" >> $GITHUB_ENV

    - name: ğŸ› ï¸ Installation de la CLI Supabase
      uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51
      with:
        version: latest

    - name: ğŸª† Creation de la branche Supabase
      run: |
       supabase branches --experimental --project-ref ${SUPABASE_PROJECT_ID} create ${REVIEW_APP_NAME}

    - name: ğŸ¤¹â€â™€ï¸ Export des variables d'environment Ã  partir de Supabase
      shell: bash
      run: |
        retries=0
        status=1
        supabase branches --project-ref ${SUPABASE_PROJECT_ID} get ${REVIEW_APP_NAME} &> /dev/null && status=${PIPESTATUS[0]} || status=${PIPESTATUS[0]}

        until [[ ${status} == 0 || ${retries} == 20 ]]
        do
          echo "âŒ L'essai ${retries} a Ã©chouÃ©. Nouvelle tentative."
          sleep 20
          retries=$((${retries}+1))
          supabase branches --project-ref ${SUPABASE_PROJECT_ID} get ${REVIEW_APP_NAME} && status=${PIPESTATUS[0]} || status=${PIPESTATUS[0]}
        done

        env_vars=$(supabase branches --project-ref ${SUPABASE_PROJECT_ID} get ${REVIEW_APP_NAME} -o env)
        declare -A env_dict
        env_dict["DATABASE_URL"]=$(echo "${env_vars}" | grep -w "POSTGRES_URL" | sed -r 's/POSTGRES_URL=//g' | sed -r 's/\"//g')
        env_dict["SUPABASE_ANON_KEY"]=$(echo "${env_vars}" | grep -w "SUPABASE_ANON_KEY" | sed -r 's/SUPABASE_ANON_KEY=//g' | sed -r 's/\"//g')
        env_dict["SUPABASE_ADMIN_KEY"]=$(echo "${env_vars}" | grep -w "SUPABASE_SERVICE_ROLE_KEY" | sed -r 's/SUPABASE_SERVICE_ROLE_KEY=//g' | sed -r 's/\"//g')
        env_dict["SUPABASE_URL"]=$(echo "${env_vars}" | grep -w "SUPABASE_URL" | sed -r 's/SUPABASE_URL=//g' | sed -r 's/\"//g')

        # https://www.chunyangwen.com/blog/shell/bash-array-dict.html
        for key in "${!env_dict[@]}"
        do
          value=${env_dict[${key}]};
          # https://docs.github.com/fr/actions/reference/workflows-and-actions/workflow-commands#masking-a-value-in-a-log
          echo "::add-mask::${value}";
          echo "${key}=${value}" >> $GITHUB_ENV
        done

    - name: ğŸ› ï¸ Installation de la CLI Scalingo
      uses: scalingo-community/setup-scalingo@87fe86eedc708ffb9d232c756b21f6a5784f6c8a # v0.1.1
      with:
        api_token: ${{ secrets.SCALINGO_API_TOKEN }}
        region: 'osc-fr1'

    - name: ğŸª† CrÃ©ation de l'application Nuxt 3
      run: |
        # Il n'est pas possible de crÃ©er une recette jetable pour Nuxt3 car chaque recette jetable
        # s'appuie sur une branche Git diffÃ©rente de celle utilisÃ©e pour le dÃ©pÃ´t parent.
        git clone https://github.com/betagouv/docurba-nuxt3.git
        cd docurba-nuxt3/
        review_app_name="nuxt3-${REVIEW_APP_NAME}"
        scalingo create "${review_app_name}"
        scalingo --app ${review_app_name} env-set \
         SUPABASE_URL="${SUPABASE_URL}" \
         SUPABASE_ADMIN_KEY="${SUPABASE_ADMIN_KEY}"
        scalingo --app "${review_app_name}" integration-link-create --branch "${NUXT3_BRANCH}" "${NUXT3_REPO_HTTPS}"
        scalingo --app "${review_app_name}" integration-link-manual-deploy main
        until scalingo --app ${review_app_name} env-get APP_URL &> /dev/null
        do
          echo "En attente de l'application Nuxt3'."
          sleep 1m
        done
        nuxt3_url=$(scalingo --app ${review_app_name} env-get APP_URL)
        echo "NUXT3_URL=${nuxt3_url}" >> $GITHUB_ENV
        echo "Utilisation de la branche ${NUXT3_BRANCH}."
        echo "Pour dÃ©ployer une autre branche, vous pouvez modifier ce script ou utiliser l'interface graphique."

    - name: ğŸª† CrÃ©ation de la recette jetable Nuxt2
      run: |
        # review_app_name="nuxt2-${REVIEW_APP_NAME}"
        # TODO(cms): remove me later.
        review_app_name="docurba-nuxt-demo-pr1535"
        # CrÃ©ation d'une recette jetable.
        scalingo --app ${SCALINGO_NUXT_APP_NAME} integration-link-manual-review-app ${{ github.event.number }}
        # Mise Ã  jour de la configuration.
        scalingo --app "${review_app_name}" integration-link-update --auto-deploy --branch "${BRANCH}" --destroy-on-close
        scalingo --app ${review_app_name} env-set \
         SUPABASE_URL="${SUPABASE_URL}" \
         SUPABASE_ADMIN_KEY="${SUPABASE_ADMIN_KEY}" \
         SUPABASE_ANON_KEY="${SUPABASE_ANON_KEY}"\
         NUXT3_API_URL="${NUXT3_URL}"
        # DÃ©ploiement manuel.
        scalingo --app "${review_app_name}" integration-link-manual-deploy "${BRANCH}"
        # RÃ©cupÃ©ration de NUXT_URL pour Django.
        until scalingo --app ${review_app_name} env-get APP_URL &> /dev/null
        do
          echo "En attente de l'application Nuxt."
          sleep 1m
        done
        nuxt_url=$(scalingo --app ${review_app_name} env-get APP_URL)
        echo "NUXT_URL=${nuxt_url}" >> $GITHUB_ENV

    - name: ğŸ› ï¸ Installation de Python
      uses: actions/setup-python@v5
      with:
        python-version-file: django/.python-version

    - name: ğŸª† CrÃ©ation de la recette jetable Django
      run: |
        # La longueur de la clÃ© secrÃ¨te doit Ãªtre supÃ©rieure Ã  50 caractÃ¨res,
        # or le gÃ©nÃ©rateur de secret de Scalingo gÃ©nÃ¨re une clÃ© de 32 caractÃ¨res.
        # Selon le support, il n'est pas possible d'en spÃ©cifier la longueur dans scalingo.json.
        django_secret_key=$(python -c "import secrets; print(secrets.token_hex(60))")
        echo "::add-mask::${django_secret_key}";
        # review_app_name="django-${REVIEW_APP_NAME}"
        # TODO(cms): remove me later.
        review_app_name="docurba-django-demo-pr1535"
        scalingo --app ${SCALINGO_DJANGO_APP_NAME} integration-link-manual-review-app ${{ github.event.number }}
        scalingo --app "${review_app_name}" integration-link-update --auto-deploy --branch "${BRANCH}" --destroy-on-close
        scalingo --app ${review_app_name} env-set \
         UPSTREAM_NUXT="${NUXT_URL}" \
         DATABASE_URL="${DATABASE_URL}" \
         SECRET_KEY="${django_secret_key}"
        scalingo --app "${review_app_name}" integration-link-manual-deploy "${BRANCH}"
        until scalingo --app ${review_app_name} env-get APP_URL &> /dev/null
        do
          echo "En attente de l'application Django."
          sleep 20
        done
        django_url=$(scalingo --app ${review_app_name} env-get APP_URL)
        echo "DJANGO_URL=${django_url}" >> $GITHUB_ENV

    - name: ğŸ» Ajout du lien en commentaire de la PR
      uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3.0.1
      with:
        message: |-
          ğŸ¥ La recette jetable est prÃªte ! [ğŸ‘‰ Je veux tester cette PR !]("${DJANGO_URL}")
